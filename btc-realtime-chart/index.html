<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BitCorn • BTC Real-Time Chart</title>
  <meta name="description" content="Live Bitcoin chart using Binance data + Lightweight Charts." />
  <!-- Lightweight Charts (CDN) -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root{
      --cream:#FAF1E6; --ink:#3C2E20; --muted:#7C6E5B; --line:#eae4da;
      --up:#00a652; --down:#d64b4b;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--cream);color:var(--ink);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .topbar{
      position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;
      padding:.6rem 1rem;border-bottom:1px solid var(--line);
      background:linear-gradient(0deg, rgba(250,241,230,.9), rgba(250,241,230,.9));
      backdrop-filter:saturate(1.2) blur(6px);
    }
    .brand{display:flex;gap:.5rem;align-items:center;font-weight:700}
    .dot{width:.7rem;height:.7rem;border-radius:50%;background:var(--up);display:inline-block}
    .controls{display:flex;gap:1rem;align-items:center;color:var(--muted)}
    select{padding:.25rem .5rem;border:1px solid var(--line);border-radius:.4rem;background:#fffaf3;color:var(--ink)}
    #app{height:calc(100vh - 94px)}
    #chart{height:100%;width:100%}
    .foot{height:40px;display:flex;gap:1rem;align-items:center;justify-content:center;border-top:1px solid var(--line);color:var(--muted)}
    @media (max-width:640px){ .controls{font-size:12px} .pair{display:none} }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand"><span class="dot"></span><strong>BitCorn</strong> BTC Chart</div>
    <div class="controls">
      <label>Interval:
        <select id="interval">
          <option value="1m" selected>1m</option>
          <option value="5m">5m</option>
          <option value="15m">15m</option>
          <option value="1h">1h</option>
          <option value="4h">4h</option>
          <option value="1d">1d</option>
        </select>
      </label>
      <span class="pair">BTC/USDT (Binance)</span>
    </div>
  </header>

  <main id="app"><div id="chart"></div></main>
  <footer class="foot"><span>Data: Binance (public)</span><span>Theme: BitCorn cream</span></footer>

  <script>
    // --- Lightweight Charts setup ---
    const container = document.getElementById('chart');
    const chart = LightweightCharts.createChart(container, {
      layout: { background: { type: 'solid', color: '#FAF1E6' }, textColor: '#3C2E20' },
      rightPriceScale: { borderVisible: false },
      timeScale: { timeVisible: true, secondsVisible: false, borderVisible: false },
      grid: { vertLines: { color: '#eae4da' }, horzLines: { color: '#eae4da' } },
    });
    const series = chart.addCandlestickSeries({
      upColor: '#00a652', downColor: '#d64b4b',
      borderVisible: false, wickUpColor: '#00a652', wickDownColor: '#d64b4b',
    });

    function resize() {
      const r = container.getBoundingClientRect();
      chart.applyOptions({ width: r.width, height: r.height });
    }
    window.addEventListener('resize', resize);
    setTimeout(resize, 50);

    // --- Binance helpers ---
    const sel = document.getElementById('interval');
    let ws;

    function klineREST(symbol, interval, limit=500) {
      return `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
    }
    function mapKlines(rows) {
      return rows.map(k => ({
        time: Math.floor(k[0] / 1000),
        open: +k[1], high: +k[2], low: +k[3], close: +k[4],
      }));
    }
    async function seed(interval) {
      const url = klineREST('BTCUSDT', interval, 500);
      const res = await fetch(url);
      const data = await res.json();
      if (!Array.isArray(data)) { console.error('Unexpected response', data); return; }
      series.setData(mapKlines(data));
    }
    function connectWS(interval) {
      if (ws) { try { ws.close(); } catch(e){} }
      const stream = `wss://stream.binance.com:9443/ws/btcusdt@kline_${interval}`;
      ws = new WebSocket(stream);
      ws.onopen = () => console.log('WS connected:', stream);
      ws.onmessage = (ev) => {
        const msg = JSON.parse(ev.data);
        if (!msg.k) return;
        const k = msg.k;
        series.update({
          time: Math.floor(k.t/1000),
          open:+k.o, high:+k.h, low:+k.l, close:+k.c
        });
      };
      ws.onclose = () => { console.warn('WS closed, retrying in 2s…'); setTimeout(()=>connectWS(interval), 2000); };
      ws.onerror = (e) => console.error('WS error:', e);
    }

    // --- Init ---
    (async () => {
      await seed(sel.value);
      connectWS(sel.value);
    })();

    sel.addEventListener('change', async () => {
      await seed(sel.value);
      connectWS(sel.value);
    });
  </script>
</body>
</html>
